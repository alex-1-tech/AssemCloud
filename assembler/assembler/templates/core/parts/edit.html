{% extends 'base.html' %}
{% block title %}{{ title }}{% endblock %}
{% block content %}
    <div class="row justify-content-center mt-5">
        <div class="col-md-10">
            <div class="card shadow-sm">
                <div class="card-body p-5">
                    <h3 class="card-title mb-4 text-center">{{ title }}</h3>
                    <form method="post" id="part-form">
                        {% csrf_token %}
                        {% for field in form %}
                            <div class="mb-3">
                                <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                                {{ field }}
                                {% if field.errors %}<div class="text-danger small">{{ field.errors }}</div>{% endif %}
                            </div>
                        {% endfor %}
                        <h5>Связи с модулями</h5>
                        {{ formset.management_form }}
                        <div id="formset-container">
                            {% for f in formset %}
                                {% for hidden in f.hidden_fields %}{{ hidden }}{% endfor %}
                            {% endfor %}
                        </div>
                        <button type="button" id="add-form" class="btn btn-secondary mb-4">Добавить связь</button>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">{{ submit_label|default:"Сохранить" }}</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block extra_scripts %}
    <script>
document.addEventListener('DOMContentLoaded', function () {
    const addButton = document.getElementById('add-form');
    const formsetContainer = document.getElementById('formset-container');
    const totalForms = document.querySelector('input[name="{{ formset.prefix }}-TOTAL_FORMS"]');

    const emptyFormHtml = `{% include "core/parts/empty_form.html" with prefix=formset.prefix module_choices=module_choices %}`;

    formsetContainer.querySelectorAll('.formset-row').forEach(addDeleteButton);

addButton.addEventListener('click', function () {
    const formCount = parseInt(totalForms.value);
    const newHtml = emptyFormHtml.replace(/__prefix__/g, formCount);

    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = newHtml;

    const formRow = tempDiv.querySelector('.formset-row');
    if (formRow) {
        addDeleteButton(formRow);
        formsetContainer.appendChild(formRow);
    } else {
        addDeleteButton(tempDiv);
        formsetContainer.appendChild(tempDiv);
    }

    totalForms.value = formCount + 1;
});

    function addDeleteButton(formRow) {
        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'btn btn-danger btn-sm mt-2';
        deleteBtn.textContent = 'Удалить';

        deleteBtn.addEventListener('click', function () {
            const deleteCheckbox = formRow.querySelector('input[type="checkbox"][name*="-DELETE"]');
            if (deleteCheckbox) {
                deleteCheckbox.checked = true;
                formRow.style.display = 'none';
            } else {
                formRow.remove();
                totalForms.value = parseInt(totalForms.value) - 1;
            }
        });

        formRow.appendChild(deleteBtn);
    }
});
    </script>
{% endblock %}
