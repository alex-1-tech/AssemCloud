<style>
  .fc .fc-col-header-cell-cushion,
  .fc .fc-daygrid-day-number {
      color: inherit;
      text-decoration: none;
      cursor: default;
      pointer-events: none;
  }
</style>

<div class="card shadow-sm">
  <div class="card-body">
    <h5 class="card-title mb-3">Календарь задач</h5>
    <div id="calendar"></div>
    <div id="custom-context-menu" style="display:none; position:absolute; z-index:1000; background:#fff; border:1px solid #ccc; box-shadow:0 2px 8px rgba(0,0,0,0.15); min-width:160px;">
      <div id="add-task-menu-item" style="padding:8px 16px; cursor:pointer;">Добавить задачу</div>
    </div>
  </div>
</div>
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.7/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.7/index.global.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    var calendarEl = document.getElementById('calendar');
    var contextMenu = document.getElementById('custom-context-menu');
    var addTaskMenuItem = document.getElementById('add-task-menu-item');
    var selectedDate = null;
    var calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      locale: 'ru',
      height: 600,
      events: {{ calendar_events|safe }},
      dateClick: function(info) {
      }
    });
    calendar.render();

    calendarEl.addEventListener('contextmenu', function(e) {
      var target = e.target;
      if (target.classList.contains('fc-daygrid-day-frame') || target.closest('.fc-daygrid-day')) {
        e.preventDefault();
        var dayCell = target.closest('.fc-daygrid-day');
        if (dayCell && dayCell.dataset && dayCell.dataset.date) {
          selectedDate = dayCell.dataset.date;
        } else {
          selectedDate = null;
        }
        contextMenu.style.display = 'block';
        contextMenu.style.left = e.pageX + 'px';
        contextMenu.style.top = e.pageY + 'px';
      } else {
        contextMenu.style.display = 'none';
      }
    });

    addTaskMenuItem.addEventListener('click', function() {
      contextMenu.style.display = 'none';
      var url = '/tasks/add/';
      if (selectedDate) {
        url += '?due_date=' + encodeURIComponent(selectedDate);
      }
      window.open(url, '_blank');
    });

    document.addEventListener('click', function(e) {
      if (!contextMenu.contains(e.target)) {
        contextMenu.style.display = 'none';
      }
    });
    window.addEventListener('scroll', function() {
      contextMenu.style.display = 'none';
    });
  });
</script>